# ros-transform-tracker

Package for tracking the state of ros transform data from the `/tf` and `/tf_static` ros topics over time, extracting transform information in different frames, and looking back to find transform positions at different points in time.

<!--{package-dependencies ./package.json}-->

# Use

```js
import { RosTransformTracker } from '@gov.nasa.jpl.honeycomb/ros-transform-tracker';

const tracker = new RosTransformTracker();
ws.subscribe('/tf', msg => tracker.applyMessage(msg, '/tf'));
ws.subscribe('/tf_static', msg => tracker.applyMessage(msg, '/tf_static'));

// get the local transform of "base_link" in "world"
const localTransform = new Matrix4().identity();
tracker.getTransformInFrame('base_link', 'world', localTransform);

// Apply the transform message to the given object in world space
const pointCloud;
const pcMessage;
tracker.applyMessageInFixedFrame(pointCloud, pcMessage.header, pcMessage.transform);
```

# API

<!-- START_AUTOGENERATED_DOCS -->
## Functions
### compareTimeStamps<a name="compareTimeStamps"></a>

```js
compareTimeStamps( a : RosTimeStamp, b : RosTimeStamp ) : void
```

Returns a number > 0 if a is larger than b, 0 if they're equal,
a negative number if a is less than b.

### getInFrame<a name="getInFrame"></a>

```js
getInFrame(
	toTransform : RosFrame, 
	rosFrame : RosFrame, 
	posOut : Vector3, 
	rotOut : Vector4
) : void
```

Gets the position and orientation of frame `rosFrame` in `toTransform`.

## RosTransformTrackerBase

An abstract base class for tracking and extracting ros transforms over time.

### reset<a name="RosTransformTrackerBase#reset"></a>

```js
reset( resetStatic : Boolean = true ) : void
```

Reset all the transform information to start from scratch. If `resetStatic` is true
then static frames are also reset.

### applyMessage<a name="RosTransformTrackerBase#applyMessage"></a>

```js
applyMessage( msg : RosTfMessage, topic : '/tf' | '/tf_static' ) : void
```

Apply a tf message to the tracked transforms. If the message timestamp is earlier
than the last applied message to a certain transform then it is skipped.

### getTransformInRootFrame<a name="RosTransformTrackerBase#getTransformInRootFrame"></a>

```js
getTransformInRootFrame(
	name : string, 
	matrix : Matrix4, 
	time : RosTimeStamp | null = null
) : Boolean
```

Set "matrix" to the transform of the given frame relative to the root at the requested time. Returns
true if the frame can be derived, false otherwise.

### getTransformInFrame<a name="RosTransformTrackerBase#getTransformInFrame"></a>

```js
getTransformInFrame(
	fromFrame : string, 
	toFrame : string, 
	matrix : Matrix4, 
	time : RosTimeStamp | null = null
) : Boolean
```

Matrix is a transform matrix relative to the frame called `fromFrame`. `matrix`
is modified to be relative to the frame called `toFrame`. If `time` is provided
then it is relative to those frames at that given time which is derived by
looking back through the available frames.

Returns `false` if the requested frames could not be located in the available
lookback transform messages.

### getWorldPoseAtTime<a name="RosTransformTrackerBase#getWorldPoseAtTime"></a>

```js
getWorldPoseAtTime(
	name : String, 
	time : RosTimeStamp, 
	outPos : Vector3, 
	outRot : Vector4
) : Boolean
```

Outputs the position and rotation of the frame with the given name at the given
ROS time. The position data is put on the `outPos` object and rotation on
`outRot`. The `x`, `y`, `z`, and `w` (for rotation) fields will be added if
they're not available.

Returns false if the time frame could not be found. True if it was found
successfully.

### getParentName<a name="RosTransformTrackerBase#getParentName"></a>

```js
getParentName( name : String ) : String | null
```

Returns the name of te parent of the provided frame. Returns null
if the frame does not exist or it has no parent.

### seekBack<a name="RosTransformTrackerBase#seekBack"></a>

```js
seekBack( cb : Function ) : void
```

Overrideable function that should iterate over the frames back in time starting
at the last applied message passing an object that looks like so into the
callback function `cb`:
```null
{
    '/tf' : RosTfMessage,
    '/tf_static : RosTfMessage
}
```

If `cb` returns `true` the iteration should stop.

## RosTransformTracker

Transform tracker that retains a buffer of tf and tf_static ros messages over time so
they can be used to derive the latest position of a ros frame.

_extends RosTransformTrackerBase_

### constructor

```js
constructor( bufferMs : Number = 10000 ) : void
```

As well as the name of the root fixed frame to provide transforms relative to a buffer in
milliseconds is provided so we know how long to keep data around.

### applyMessage<a name="RosTransformTracker#applyMessage"></a>

```js
applyMessage( msg : RosTfMessage, topic : '/tf' | '/tf_static' ) : void
```

Override of [RosTransformTrackerBase.applyMessage](#RosTransformTrackerBase#applyMessage) that

### seekBack<a name="RosTransformTracker#seekBack"></a>

```js
seekBack( cb : Function ) : void
```

Override of [RosTransformTrackerBase.seekBack](#RosTransformTrackerBase#seekBack) that
iterates over the the stored messages from latest to earliest.

### reset<a name="RosTransformTracker#reset"></a>

```js
reset( resetStatic : null, cb : Function ) : void
```

Override of [RosTransformTrackerBase.reset](#RosTransformTrackerBase#reset) that
clears the saved messages as well as the transforms.

## RosTimeStamp

### secs<a name="RosTimeStamp#secs"></a>

```js
secs : Number
```



### nsecs<a name="RosTimeStamp#nsecs"></a>

```js
nsecs : Number
```



### sec<a name="RosTimeStamp#sec"></a>

```js
sec : Number
```



### nsec<a name="RosTimeStamp#nsec"></a>

```js
nsec : Number
```



## RosFrame

### position<a name="RosFrame#position"></a>

```js
position : Array<Number>
```



### orientation<a name="RosFrame#orientation"></a>

```js
orientation : Array<Number>
```



### translation<a name="RosFrame#translation"></a>

```js
translation : Array<Number>
```



### rotation<a name="RosFrame#rotation"></a>

```js
rotation : Array<Number>
```




<!-- END_AUTOGENERATED_DOCS -->
